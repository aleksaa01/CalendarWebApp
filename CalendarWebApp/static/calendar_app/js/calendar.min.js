let n={},a=document.getElementById("access-token").innerText,d=document.getElementById("refresh-token").innerText,r=null;function i(){xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){if(xhr.readyState==xhr.DONE)if(200==xhr.status){event_list=JSON.parse(xhr.responseText);for(let e in event_list)s(event_list[e])}else{if(401==xhr.status)return w(),void i();console.log("fetchCalendarEvents failed")}},xhr.open("GET","/calendar/event/",!1),xhr.setRequestHeader("Authorization","Bearer "+a),xhr.send()}function s(e){n[e.year]||(n[e.year]={}),n[e.year][e.month]||(n[e.year][e.month]={}),n[e.year][e.month][e.day]||(n[e.year][e.month][e.day]=e)}function o(e){return!!n[e.year]&&(!!n[e.year][e.month]&&!!n[e.year][e.month][e.day])}function l(e){delete n[e.year][e.month][e.day]}function c(e,t){let n="";for(let a=e;a<=t;a++)n+="<option value='"+a+"'>"+a+"</option>";return n}i(),document.getElementById("close-modal").addEventListener("click",B),document.getElementById("modal-create").addEventListener("click",A),document.getElementById("modal-delete").addEventListener("click",I),document.getElementById("modal-save").addEventListener("click",T);let u=new Date,m=u.getMonth(),h=u.getFullYear(),y=document.getElementById("calendar"),g=["January","February","March","April","May","June","July","August","September","October","November","December"],f=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],p="<tr>";for(day in f)p+="<th data-days='"+f[day]+"'>"+f[day]+"</th>";function x(){h=11===m?h+1:h,E(m=(m+1)%12,h)}function v(){h=0===m?h-1:h,E(m=0===m?11:m-1,h)}function E(e,t){let a=new Date(t,e).getDay();tbl=document.getElementById("calendar-body"),monthAndYear.innerHTML=g[e]+" "+t,tbl.innerHTML="";let d=1,r=L(e,t),i=u.getFullYear()+u.getMonth()/100+u.getDate()/1e4;for(let s=0;s<6;s++){let l=document.createElement("tr");for(let c=0;c<7;c++)if(0===s&&c<a)cell=document.createElement("td"),cellText=document.createTextNode(""),cell.appendChild(cellText),l.appendChild(cell);else{if(d>r)break;cell=document.createElement("td"),cell.setAttribute("data-day",d),cell.setAttribute("data-month",e+1),cell.setAttribute("data-year",t),cell.className="date-picker",cell.innerHTML="<span>"+d+"</span>",t+e/100+d/1e4<i?cell.classList.add("disabled-td"):(cell.classList.add("hoverable-td"),o({year:t,month:e+1,day:d})&&(cell.setAttribute("data-id",n[t][e+1][d].id),cell.classList.add("occupied-td"))),l.appendChild(cell),d++}tbl.appendChild(l)}}function L(e,t){return 32-new Date(t,e,32).getDate()}function b(e){let t=document.getElementById("modal"),n=document.getElementById("modal-text"),a=document.getElementById("modal-delete"),d=document.getElementById("modal-create"),r=document.getElementById("modal-save");void 0===e.description?(a.classList.add("hidden"),d.classList.remove("hidden"),r.classList.add("hidden"),n.value=""):(a.classList.remove("hidden"),d.classList.add("hidden"),r.classList.remove("hidden"),n.value=e.description),e.id&&t.setAttribute("data-id",e.id),t.setAttribute("data-day",e.day),t.setAttribute("data-month",e.month),t.setAttribute("data-year",e.year),t.classList.toggle("hidden")}function B(){document.getElementById("modal").classList.add("hidden")}function A(){let e=document.getElementById("modal"),t=document.getElementById("modal-text"),n={day:e.getAttribute("data-day"),month:e.getAttribute("data-month"),year:e.getAttribute("data-year"),description:t.value};xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){if(xhr.readyState==xhr.DONE)return 200==xhr.status||201==xhr.status?(event=JSON.parse(xhr.responseText),s(event),r.setAttribute("data-id",event.id),r.classList.add("occupied-td"),void B()):401==xhr.status?(w(),void A()):void console.log("createEvent failed:")},xhr.open("POST","/calendar/event/"),xhr.setRequestHeader("Authorization","Bearer "+a),xhr.setRequestHeader("Content-Type","application/json"),xhr.send(JSON.stringify(n))}function I(){let e=document.getElementById("modal"),t=e.getAttribute("data-id");if(!t)return;let n=document.getElementById("modal-text"),d={id:t,day:e.getAttribute("data-day"),month:e.getAttribute("data-month"),year:e.getAttribute("data-year"),description:n.value},i="/calendar/event/"+t;xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){if(xhr.readyState==xhr.DONE){if(204==xhr.status)return l(d),r.removeAttribute("data-id"),r.classList.remove("occupied-td"),void B();if(401==xhr.status)return w(),void I();console.log("deleteEvent failed:")}},xhr.open("DELETE",i),xhr.setRequestHeader("Authorization","Bearer "+a),xhr.send()}function T(){let e=document.getElementById("modal"),t=e.getAttribute("data-id");if(!t)return;let d=document.getElementById("modal-text"),r=e.getAttribute("data-day"),i=e.getAttribute("data-month"),s=e.getAttribute("data-year"),o="/calendar/event/"+t;event=n[s][i][r],event.description=d.value,xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){if(xhr.readyState==xhr.DONE){if(200==xhr.status||201==xhr.status)return void B();if(401==xhr.status)return w(),void T();console.log("saveEvent failed:")}},xhr.open("PUT",o),xhr.setRequestHeader("Authorization","Bearer "+a),xhr.setRequestHeader("Content-Type","application/json"),xhr.send(JSON.stringify(event))}function w(){let e={refresh:d};xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){xhr.readyState==xhr.DONE&&(200==xhr.status||201==xhr.status?a=JSON.parse(xhr.responseText).access:401==xhr.status?window.location.href="/":console.log("getAccessToken failed:"))},xhr.open("POST","/api/token/refresh/",!1),xhr.setRequestHeader("Content-Type","application/json"),xhr.send(JSON.stringify(e))}p+="</tr>",document.getElementById("thead-month").innerHTML=p,monthAndYear=document.getElementById("monthAndYear"),E(m,h),document.getElementById("previous").addEventListener("click",v),document.getElementById("next").addEventListener("click",x),y.addEventListener("click",function(e){if(elem=e.target,!elem.classList.contains("date-picker")){if(!elem.parentNode.classList.contains("date-picker"))return;elem=elem.parentNode}if(elem.classList.contains("disabled-td"))return;let t,a=elem.getAttribute("data-id"),d=elem.getAttribute("data-day"),i=elem.getAttribute("data-month"),s=elem.getAttribute("data-year");t=a?n[s][i][d]:{day:d,month:i,year:s},r=elem,b(t)});